<!DOCTYPE html>
<html>
  <head>
    <title>-</title>
  </head>
  <body>
    {--title--}Project - Vehicle traffic statistics{----}
    
    {--projects_current--} <span class="sr-only">(current)</span>{----}
    
    {--projects_active--} active{----}
        
    {--body--}
      <h1>Vehicle traffic statistics</h1>

      <h2>Introduction</h2>
      <div class="box">
        <p>This module provides information about the number of vehicles 
          detected by the sensor located at Laure&agrave; Mir&oacute; Street in 
          Sant Feliu de Llobregat. This sensor is published on the Sentilo platform.
          The following picture shows the system architecture:
        </p>
        <img src="projects/vehicle_stats/vehicle_statistics_schema.svg" class="image" alt="">
        <p>
          <a href="http://sentilo.io">Sentilo</a> is an open source sensor 
          and actuator platform designed to fit in the Smart City architecture 
          of any city looking for openness and easy interoperability.
          This platform provides a simple 
          <a href="http://www.sentilo.io/xwiki/bin/view/APIDocs/WebHome">HTTP REST API</a> 
          to manage sensory data.
        </p>
        <p>
          This module has three dashboards to show the traffic information. The first one, 
          called Statistics, has a text box with the following information:
        </p>
        <ul>
          <li>Number of vehicles: sensor current data</li>
          <li>Vehicles/3600sec: number of vehicles in the past hour</li>
          <li>Last access: date of the last information using the format "dd MMM yyyy HH:mm:ss"</li>
        </ul>
        <p>
          In addition, it has a graphic widget showing the number of vehicles per hour 
          in a week period.
        </p>
        <p>
          The second and third are called Current Data and Times. They have a graphic widget and a text box. 
          The graphic 'Number of Vehicles' shows how the number of vehicles develops over time.
          The graphic widget called 'Time between vehicles' shows two different parameters: 
          the time between two consecutive vehicles and the average of these times.
          Text box is the same in both dashboards and shows these data: 
        </p>
        <ul>
          <li>Average time (sec): Average time between vehicles</li>
          <li>Number of vehicles: sensor current data</li>
          <li>Last data: date of the last information using the format "dd MMM yyyy HH:mm:ss"</li>
        </ul>        
      </div>
      
      <h2>Programming the module</h2>
      <div class="box">
        <p>The sensor publishes its data in Sentilo, so the information 
          is available in the platform. The first code executed, once the module 
          is initiated, is that contained in the <span class="code">start</span> variable: 
        </p>
        <div class="code">
          <code>(do
  (### "Starts the main loop")
  (spawn (eval loop))
  (### "Creates the subscription to the sensor")
  (sentilo/suscription setup/instances/santfeliu setup/sensor))
          </code>
        </div>
        <p>The <span class="code">sentilo/subscription</span> function launches 
          a subscription to the sensor data. It means that every data generated by the 
          sensor will be delivered to the module too:
        </p>
        <div class="code">
          <code>
(function
  (sentilo_instance sensor)
  (http
    "PUT"
    (concat
      sentilo_instance/url
      "/subscribe/data/"
      sensor/provider
      "/"
      sensor/ID
    )
    "body" => "{\"endpoint\" : \"http://smartcity.santfeliu.cat/brain4it-server-web/modules/VehicleStatistics/@callback\"}"
    "properties" => (list "IDENTITY_KEY" => sensor/key)
  )
)
		   </code>
        </div>        
        <p>
         Since the module is subscribed to the sensor, whenever a new value is 
         generated, the function <span class="code">@callback</span> is called:          
        </p>
        <div class="code">
          <code>
          (function
            (context data)
            (### "This function is called every time a vehicle is detected")
            (set variables/data (parse data "json"))
            (%soft_add-node-to-history)
            (%soft_calculate-time-between-vehicles)
            (%soft_calculate-average-time-between-vehicles)
            (module-notify 
              "@get-history"
              "@get-value"
              "@get-history-time"
              "@get-value-time"
              "@get-display-current-values")
          )
   		   </code>
        </div>
        <p>This data is added to a list and showed in Current_Data dashboard.</p>
        <p>In order to complete the module functionality, <span class="code">loop</span> 
          is started before the subscription and the sensor current value will 
          be obtained every <span class="code">variables/access_interval_sec</span> seconds:
        </p>
        <div class="code">
          <code>
        (while
          true
          (try
            (do
              (### "Every access_interval_sec a new value is generated")
              (%soft_generate-data)
              (sleep (* 1000 setup/access_interval_sec))
            )
            (ex
              "*" =>
              (do
                (###
                  "When an error takes place, it is saved in a variable named 'error'"
                )
                (set error (list (format-date (date)) ex))
                (sleep (* 1000 setup/access_interval_sec))
              )
            )
          )
        )
		   </code>
        </div>
        <p>The function <span class="code">generate-data</span> is responsible for getting the value and
          adding it to the list that will be represented in the Statistics dashboard.
        </p>
        <p>The user views are the following:</p>
        (* images * )
        <p>The <span class="code">stop</span> code is executed when module is stopped. 
          It launches the unsubscribe command to Sentilo in order to delete the subscription.
        </p>
        <div class="code">
          <code>
          (do
            (### "Delete sensor suscription")
            (sentilo/unsuscription setup/instances/santfeliu setup/sensor)
          )
          </code>
        </div>
        <p>This is the function that performs the unsuscription action:</p>
        <div class="code">
          <code>
          (function
            (sentilo_instance sensor)
            (http
              "DELETE"
              (concat
                sentilo_instance/url
                "/subscribe/data/"
                sensor/provider
                "/"
                sensor/ID
              )
              "properties" => (list "IDENTITY_KEY" => sensor/key)
            )
          )
          </code>
        </div>
      </div>
      
      <a href="projects/vehicle_stats/vehicle_stats.snp" 
         download="vehicle_stats.snp"
         class="btn btn-info read-more" role="button">Download module</a>
    {----}
  </body>
</html>
